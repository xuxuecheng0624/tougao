

<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>在线投稿</title>
  <meta name="renderer" content="webkit">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <base th:href="${#request.getContextPath()}+'/'">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=0">
  <link rel="stylesheet" href="layuiadmin/layui/css/layui.css" media="all">
  <link rel="stylesheet" href="layuiadmin/style/admin.css" media="all">
  <link rel="stylesheet" type="text/css" href="layuiadmin/layui/css/fzBase_v2109.css" media="all"/>
  <link rel="stylesheet" type="text/css" href="layuiadmin/layui/css/fz_cj_houtaixitong.css" media="all"/>
  <script src="ueditor/ueditor.config.js"></script>
  <script src="ueditor/ueditor.all.min.js"></script>
  <script src="ueditor/lang/zh-cn/zh-cn.js"></script>
</head>

<style>
  dl {
    bottom: unset !important;
    z-index: 99999 !important;
    min-height: 300px;
    min-width: 288px;
  }
</style>
<body>

  <div class="layui-fluid">
    <div class="layui-card" style="background-color: transparent;">
      <div class="gjlb_tit_top"><span>在线投稿</span></div>
      <div class="yibao_lrab">
        <div class="yibao_lefta">
          <div class="yibao_neineien">
            <p>投稿说明：</p>
            <p>1. 投稿栏目主要包括图书交流、工作动态、综述纪要、政策法规、领导讲话、调研督查、经验交流、宣传教育、开发利用等。</p>
            <p>2. 投稿内容须符合国家相关法律法规。</p>
            <p>3. 投稿内容需与地方志事业相关。</p>
            <p>4. 稿件若为图文并茂形式，请注明准确图说后一并投递。投稿图片须版权归属清晰。</p>
            <p> 5. 投稿前请核对，明确时间、地点、人物、职务（职称）、会议活动名称等关键要素；勿重复投递。</p>
            <p>6. 投稿请准确注明信息来源、供稿单位，若有照片，请注明摄影者。</p>

          </div>
        </div>
        <div class="yibao_leftb"></div>
      </div>
      <div class="layui-card-body" style="padding: 15px;">
        <form class="layui-form" action="" id="form" lay-filter="component-form-group">

          <div class="layui-form-item">
            <div class="layui-inline">
              <label class="layui-form-label bb_xinhao">标&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;题</label>
              <div class="layui-input-inline">
                <input type="text" name="title" lay-verify="title" autocomplete="off" class="layui-input teshuinputjian">
              </div>
            </div>
            <div class="layui-inline">
              <label class="layui-form-label bb_xinhao">投稿栏目</label>
              <div class="layui-input-inline">
                <div class="thzczhurou">
                  <select name="chnlId" style="z-index: 999999;" id="qChannel" lay-verify="aihao"  lay-filter="aihao">
                    <option value=""></option>
                  </select>
                </div>

              </div>
            </div>
          </div>


          <div class="layui-form-item">
            <div class="layui-inline">
              <label class="layui-form-label">作者单位</label>
              <div class="layui-input-inline">
                <input type="text" name="opusUnit"   autocomplete="off" class="layui-input">
              </div>
            </div>
            <div class="layui-inline">
              <label class="layui-form-label bb_xinhao">作者姓名</label>
              <div class="layui-input-inline">
                <input type="text" name="author"  lay-verify="author"  autocomplete="off" class="layui-input">
              </div>
            </div>

          </div>

          <!--新增表单字段 Begin-->

          <div class="layui-form-item new ">
            <div class="layui-inline">
              <label class="layui-form-label">出&nbsp;&nbsp;版&nbsp;&nbsp;社</label>
              <div class="layui-input-inline">
                <input type="text" name="pressName"   autocomplete="off" class="layui-input teshuinputjian">
              </div>
            </div>
            <div class="layui-inline">
              <label class="layui-form-label">出版时间</label>
              <div class="layui-input-inline">
                <!--<input type="text" name="username" lay-verify="required"  autocomplete="off" class="layui-input teshuinputjian">-->
                <input type="text" name="publishTime" id="date1" autocomplete="off" class="layui-input">
              </div>
            </div>
          </div>

          <div class="layui-form-item new ">
            <div class="layui-inline">
              <label class="layui-form-label">版&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;次</label>
              <div class="layui-input-inline">
                <input type="text" name="edition"  autocomplete="off" class="layui-input teshuinputjian">
              </div>
            </div>
            <div class="layui-inline">
              <label class="layui-form-label">印&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;次</label>
              <div class="layui-input-inline">
                <input type="text" name="impression"  autocomplete="off" class="layui-input teshuinputjian">
              </div>
            </div>
          </div>

          <div class="layui-form-item new ">
            <div class="layui-inline">
              <label class="layui-form-label">字&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;数</label>
              <div class="layui-input-inline">
                <input type="text" name="wordNum" autocomplete="off" class="layui-input teshuinputjian">
              </div>
            </div>
            <div class="layui-inline">
              <label class="layui-form-label">页&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;数</label>
              <div class="layui-input-inline">
                <input type="text" name="pageNum"   autocomplete="off" class="layui-input teshuinputjian">
              </div>
            </div>
          </div>

          <div class="layui-form-item new">
            <div class="layui-inline">
              <label class="layui-form-label">装&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;帧</label>
              <div class="layui-input-inline">
                <input type="text" name="bind"  autocomplete="off" class="layui-input teshuinputjian">
              </div>
            </div>
            <div class="layui-inline">
              <label class="layui-form-label">品&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;相</label>
              <div class="layui-input-inline">
                <input type="text" name="phase" autocomplete="off" class="layui-input teshuinputjian">
              </div>
            </div>
          </div>

          <div class="layui-form-item new">
            <div class="layui-inline new">
              <label class="layui-form-label ">联&nbsp;&nbsp;系&nbsp;&nbsp;人</label>
              <div class="layui-input-inline">
                <input type="text" name="linkman"  lay-verify="linkman" autocomplete="off" class="layui-input">
              </div>
            </div>
            <div class="layui-inline">
              <label class="layui-form-label bb_xinhao">联系方式</label>
              <div class="layui-input-inline">
                <input type="text" name="telephone"  lay-verify="telephone" autocomplete="off" class="layui-input">
              </div>
            </div>
          </div>

          <div class="layui-form-item new">
            <div class="layui-inline new">
              <label class="layui-form-label">定&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;价</label>
              <div class="layui-input-inline">
                <input type="text" name="price" autocomplete="off" class="layui-input teshuinputjian">
              </div>
            </div>
          </div>

          <!--新增表单字段 End-->

          <div class="layui-form-item layui-form-text">
            <label class="layui-form-label">内&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;容</label>
            <div class="layui-input-block">
              <textarea name="content" placeholder="请输入内容" lay-verify="content" id="demo"  style="min-height: 500px"   class="layui-textarea teshuareajian"></textarea>
            </div>
          </div>

          <div class="layui-form-item layui-form-text">
            <label class="layui-form-label ">备&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;注</label>
            <div class="layui-input-block">
              <textarea name="notes" placeholder="请输入备注" class="layui-textarea" lay-verify="notes"></textarea>
              注：输入内容不能超出1000个汉字
            </div>
          </div>

          <div class="layui-form-item">
            <label class="layui-form-label ">图&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;片</label>
            <div class="layui-input-block" id="images">
              <button type="button" class="layui-btn-wo" id="test-upload-size">上传图片</button>
              <input type="hidden" id="img_url" name="imagesAddress" value="" />
              <input type="hidden" id="img_name" name="imagesName" value="" />
              <div class="layui-inline layui-word-aux">
                支持大小不超过2M的 jpg,png.gif图片
              </div>
              <div id="imagesContainer">

              </div>
            </div>
          </div>

          <div class="layui-form-item">
            <label class="layui-form-label ">附&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;件</label>
            <div class="layui-input-block">
              <button type="button" class="layui-btn-wo" id="test-upload-type1">选择附件</button>
              <input type="hidden" id="file_url" name="appendixAddress" value=""/>
              <input type="hidden" id="file_name" name="appendixName" value=""/>
              <div class="layui-upload-list">
                <p id="demoText2"></p>
              </div>
              <div class="layui-inline  layui-word-aux">
                附件支持的类型：txt,pdf,doc,docx,xls,xlsx,ppt,pptx,rar,jpg,jpeg,gif,png,bmp; 大小20480KB以内
              </div>
              <div id="textContainer">
              </div>
            </div>
          </div>


          <div class="layui-form-item">
            <div class="layui-input-block">
              <div class="layui-footer" style="left: 0; text-align: center; padding-top: 30px;">
                <button class="layui-btn lb_tijiao" lay-submit="" lay-filter="component-form-demo1">草稿箱</button>
                <button class="layui-btn lb_tijiao" lay-submit="" lay-filter="component-form-demo2">提交审核</button>
                <button id="reset" class="layui-btn lb_tijiao2">重置信息</button>
              </div>
            </div>
          </div>
        </form>
      </div>
    </div>
  </div>


  <script th:src="@{/layuiadmin/layui/layui.js}"></script>
  <script>
      const baseUrl = "[[${#servletContext.contextPath}]]";
  </script>
  <script th:inline="none">
  layui.config({
    base: baseUrl +  '/layuiadmin/' //静态资源所在路径
  }).extend({
    index: 'lib/index' //主入口模块
  }).use(['index', 'form', 'laydate','upload','layedit'], function(){
    var $ = layui.$
    ,admin = layui.admin
    ,element = layui.element
    ,layer = layui.layer
    ,laydate = layui.laydate
    ,form = layui.form
    ,upload = layui.upload
    ,layedit = layui.layedit;

    /*layedit.set({
        uploadImage: {
            //接口url
            url: '/doc/upload/contentImg',
            type: 'post' //默认post
        }
      })
      var  index = layedit.build('demo'); //建立编辑器*/

      UE.getEditor('demo');
      /*UE.Editor.prototype._bkGetActionUrl = UE.Editor.prototype.getActionUrl;
      UE.Editor.prototype.getActionUrl = function(action) {
          if (action == 'uploadimage' || action == 'uploadscrawl' || action == 'uploadimage') {
              return 'http://103.247.176.235：9412/doc/upload/img';//此处写自定义的图片上传路径
          } else if (action == 'uploadvideo') {
              return 'http://a.b.com/vide o.php';
          } else {
              return this._bkGetActionUrl.call(this, action);
          }
      }*/



    form.render(null, 'component-form-group');

    laydate.render({
      elem: '#LAY-component-form-group-date'
    });

    laydate.render({
      elem: '#date1',
      type: 'date'
    });

    /* 自定义验证规则 */
    form.verify({
      title:function (value) {
          if (value === "") {
              return "标题不能为空";
          }
      }
      ,pass: [/(.+){6,12}$/, '密码必须6到12位']
      ,/*content: function(value){
            return layedit.sync(index);
      },*/
        aihao:function (value) {
            if (value === "") {
              return "投稿栏目不能为空";
            }
        }
        ,notes:function (value) {
            if (value !== "") {
                if (value.length > 1000) {
                  return "备注字数不能超过1000字";
                }
            }
        }
        ,telephone:function (value) {
            if($("#qChannel").val()=="图书交流") {
                if (value === "") {
                    return "联系方式不能为空";
                }
            }
        }
        ,author:function (value) {
            if (value === "") {
                return "作者不能为空";
            }
        }
    });

      function getRootPath() {
          var pathName = window.location.pathname.substring(1);
          var webName = pathName == '' ? '' : pathName.substring(0, pathName.indexOf('/'));
          return window.location.protocol + '//' + window.location.host + '/';
      }

    /* 监听指定开关 */
    form.on('switch(component-form-switchTest)', function(data){
      layer.msg('开关checked：'+ (this.checked ? 'true' : 'false'), {
        offset: '6px'
      });
      layer.tips('温馨提示：请注意开关状态的文字可以随意定义，而不仅仅是ON|OFF', data.othis)
    });

    /* 监听提交 */
    form.on('submit(component-form-demo1)', function(data){
      /*parent.layer.alert(JSON.stringify(data.field), {
        title: '最终的提交信息'
      })*/
      // data.field.content = layedit.getContent(index);
      var imageUrl = "";
      var imageName = "";
      var fileUrl = "";
      var fileName = "";
      $(".images").each(function (val) {
          console.log($(this).attr("name"));
          imageUrl = imageUrl + $(this).attr("url") + ";".replace("\\","/");
          imageName = imageName + $(this).attr("name") + ";";
      })
      $(".docFile").each(function () {
          fileUrl = fileUrl + $(this).attr("url") + ";".replace("\\","/");
          fileName = fileName + $(this).attr("name") + ";";
      });
      data.field.imagesName = imageName;
      data.field.imagesAddress = imageUrl;
        data.field.appendixName = fileName;
        data.field.appendixAddress = fileUrl;
        data.field.status = "0";

      /*console.log(JSON.stringify(data.field));*/

          $.ajax({
            async:false,          //是否异步
            type:"post",         //请求类型
            dataType:"json",  //返回的数据类型
            contentType:"application/json",   //请求的参数类型
            url: baseUrl + "/doc/save",                    //链接地址
            data:JSON.stringify(data.field),
            success:function(data){
                if(data.code=="0"){
                    layer.msg(data.msg, { icon: 1, time: 1000, shade: [0.6, '#000', true] });
                }else{
                    layer.msg(data.msg, { icon: 2, time: 1000, shade: [0.6, '#000', true] });
                }
                setTimeout(function(){
                    var index = parent.layer.getFrameIndex(window.name);
                    parent.layer.close(index);//关闭当前页
                }, 1000);
            },error:function(){
                alert("进来了error"+data);
            }
        })
      return false;
    });

    $("#reset").click(function () {
        $("#form")[0].reset();
        $('#LAY_layedit_1').contents().find('body').html('');
        layui.form.render();
    })

      form.on('submit(component-form-demo2)', function(data){
          var imageUrl = "";
          var imageName = "";
          var fileUrl = "";
          var fileName = "";
          $(".images").each(function (val) {
              console.log($(this).attr("name"));
              imageUrl = imageUrl + $(this).attr("url") + ";".replace("\\","/");
              imageName = imageName + $(this).attr("name") + ";";
          })
          $(".docFile").each(function () {
              fileUrl = fileUrl + $(this).attr("url") + ";".replace("\\","/");
              fileName = fileName + $(this).attr("name") + ";";
          });
          data.field.imagesName = imageName;
          data.field.imagesAddress = imageUrl;
          data.field.appendixName = fileName;
          data.field.appendixAddress = fileUrl;
          data.field.status = "1";

          console.log(JSON.stringify(data.field));

          $.ajax({
              async:false,          //是否异步
              type:"post",         //请求类型
              dataType:"json",  //返回的数据类型
              contentType:"application/json",   //请求的参数类型
              url: baseUrl + "/doc/save",                    //链接地址
              data:JSON.stringify(data.field),
              success:function(data){
                  if(data.code=="0"){
                      layer.msg("推送审核成功",{icon:1});
                  }else{
                      layer.msg("推送审核失败，请稍后再试",{icon:2});
                  }
                  setTimeout(function(){
                      var index = parent.layer.getFrameIndex(window.name);
                      parent.layer.close(index);//关闭当前页
                  }, 1000);
              },error:function(){
                  alert("进来了error"+data);
              }
          })
          return false;
      });



      var uploadInst = upload.render({
          elem: '#test-upload-size' //绑定元素
          ,url: baseUrl + '/doc/upload/img' //上传接口
          ,multiple: true
          ,before: function(obj){
              //预读本地文件示例，不支持ie8
              layer.msg('图片上传中...', {
                  icon: 16,
                  shade: 0.01,
                  time: 0
              })
          }
          ,done: function(res){
              //如果上传失败
              if(res.code > 0){
                  return layer.msg('上传失败');
              }
              layer.close(layer.msg('上传成功！'));
              var imgurl = "http://192.168.74.137:7001/tougao" + res.url.split("static")[1].replace("\\","/")
                  console.log(imgurl)
              $("#imagesContainer").append("<div class=\"layui-upload-list layui-inline\">\n" +
                      "<i class=\"layui-icon delete\"></i>"+
                  "                <img class=\"layui-upload-img images\" name='"+res.name+"' url='"+res.url.split("static")[1].replace("\\","/")+"' src='"+baseUrl+"/doc/showImg?imgUrl="+res.name+"' width=\"100px\" height=\"80px\"/>\n" +
                  "                <p id=\"demoText\"></p>\n" +
                  "              </div>");

              $(".delete").click(function(){
                  $(this).parent().remove();
                  $.ajax({
                      async:false,          //是否异步
                      type:"get",         //请求类型
                      dataType:"json",  //返回的数据类型
                      contentType:"application/json",   //请求的参数类型
                      url:baseUrl +  "/doc/upload/delete",                    //链接地址
                      data:{
                          "path":$(this).siblings("img").attr("url")
                      },
                      success:function(data){
                          layer.msg(data.isDelete);
                      },error:function(){
                          alert("进来了error"+data);
                      }
                  })
              })

          }
          ,error: function(){
              //演示失败状态，并实现重传
              var demoText = $('#demoText');
              demoText.html('<span style="color: #FF5722;">上传失败</span> <a class="layui-btn layui-btn-mini demo-reload">重试</a>');
              demoText.find('.demo-reload').on('click', function(){
                  uploadInst.upload();
              });
          }
      });


      var uploadInst2 = upload.render({
          elem: '#test-upload-type1' //绑定元素
          ,url: baseUrl + '/doc/upload/file' //上传接口
          ,accept: 'file'
          ,before: function(obj){
              //预读本地文件示例，不支持ie8
              layer.msg('文件上传中...', {
                  icon: 16,
                  shade: 0.01,
                  time: 0
              })
          }
          ,done: function(res){
              //如果上传失败
              if(res.code > 0){
                  return layer.msg('上传失败');
              }
              //上传成功
              layer.close(layer.msg('上传成功！'));
              $("#textContainer").append("<div class=\"layui-upload-list\">\n" + "<i class=\"layui-icon textdelete\"></i>"+"<span class='docFile' name='"+res.name+"' url='"+res.url.split("static")[1].replace("\\","/")+"' >"+res.name+"</span> </div>");
              if ($("#file_url").val() === "") {
                  document.getElementById("file_url").value =  res.url.split("static")[1].replace("\\","/");
              } else {
                  document.getElementById("file_url").value = $("#file_url").val() + ";" + res.url.split("static")[1].replace("\\","/");
              }

              $(".textdelete").click(function(){
                  $(this).parent().remove();
                  $.ajax({
                      async:false,          //是否异步
                      type:"get",         //请求类型
                      dataType:"json",  //返回的数据类型
                      contentType:"application/json",   //请求的参数类型
                      url:"/doc/upload/delete",                    //链接地址
                      data:{
                          "path":$(this).siblings("span").attr("url")
                      },
                      success:function(data){
                          layer.msg(data.isDelete);
                      },error:function(){
                          alert("进来了error"+data);
                      }
                  })
              })
          }
          ,error: function(){
              //演示失败状态，并实现重传
              var demoText = $('#demoText2');
              demoText.html('<span style="color: #FF5722;">上传失败</span> <a class="layui-btn layui-btn-mini demo-reload">重试</a>');
              demoText.find('.demo-reload').on('click', function(){
                  uploadInst2.upload();
              });
          }
      });



      var initPage = function(){
          //初始化下拉框
          var params = {};
          $.ajax({
              type: "POST",
              // timeout: 3000,
              dataType: "json",
              url:baseUrl +  "/doc/getChannel",
              success: function(d){
                  if(d.code=="0"){
                      var select = $("#qChannel");
                      $.each(d.data, function (i, v) {
                          select.append("<option value='"+v.id  +"' data='"+v.chnlName+"'>"+v.chnlName+"</option>");
                      });
                      form.render("select", "component-form-group");
                  }else{
                      layer.msg('信息获取失败！', {icon: 2});
                  }
              },
              error: function(XMLHttpRequest,textStatus,errorThrown){
                  layer.msg('信息获取失败！', {icon: 2});
              },
              complete: function(){
              }
          });
      }

      $(function(){
          initPage();
          $(".new").hide();
          form.on('select(aihao)', function(data){
            var channel = $(data.elem).find("option:selected").attr("data");
            if (channel === "图书交流") {
                $(".new").show();
            } else {
                $(".new").hide();
            }
          })
      });


  });
  </script>

</body>
</html>
